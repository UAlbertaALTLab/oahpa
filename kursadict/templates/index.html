{% extends 'base.html' %}

{% block extra_css %}
{# https://gist.github.com/1866577 #}
<script type="text/javascript" src="{{url_for('static', filename='js/bootstrap-collapse.js')}}"></script>
<script type="text/javascript" src="{{url_for('static', filename='js/bootstrap-dropdown.js')}}"></script>
<script type="text/javascript" src="{{url_for('static', filename='js/bootstrap-typeahead-fork.js')}}"></script>
<script type="text/javascript">
$(document).ready( function() {
    $('input[name="lookup"]').typeahead({
        items: 5,
        source: function (typeahead, query) {
            if (query.length > 1) {
                var _from = typeahead.$element.attr('data-language-from')
                    , _to = typeahead.$element.attr('data-language-to')
                    , url = '/autocomplete/' + _from + '/' + _to + '/'
                    ;
                return $.get(url, { lookup: query }, function (data) {
                    return typeahead.process(data);
                });
            } else {
                return [] ;
            }
        }
    });
    // Discourage submission if there is nothing to submit
    $('form').submit(function(evt) {
        var inputs = $(evt.target).find('input[type="text"]')
          , submit = $(evt.target).find('button[type="submit"]')
          ;
        for (_i = 0, _len = inputs.length; _i < _len; _i++) {
            i = inputs[_i];
            if ($(i).val().length === 0) {
                return false;
            } else {
                continue;
            }
        }
        inputs.prop("readonly", true);
        submit.prop("disabled", true);
    });

    $('.example_set button').click(function(evt) {
    	var target = $(evt.target).parents('.example_set')
    	                          .find('blockquote.examples') ;
    	console.log(target) ;
    	if (target.hasClass('hidden-phone')) {
    	    target.hide();
    	    target.removeClass('hidden-phone') ;
    	    target.slideDown() ;
    	} else {
    	    target.slideUp(400, function(){
    	        target.hide();
    	        target.addClass('hidden-phone') ;
    	    }) ;
    	}
    });
});
</script>

{% endblock %}

{% block search_li %}
{% endblock %}

{% block search_li_form %}
{% endblock %}

{% block extra_nav %}
        {% for iso_pair, names in language_pairs.iteritems() %}
            <li class="visible-thin hidden-desktop hidden-tablet {%- if iso_pair[0] == _from and iso_pair[1] == _to %} active{% endif -%}">
                <a href="/{{ iso_pair[0] }}/{{ iso_pair[1] }}/">
                {% for lang, name in names.iteritems() %}
                    <span class="i18n" lang="{{ lang }}">{{ name[0] }} ↔ {{ name[1] }}</span>
                {% endfor %}
                </a></li>
        {% endfor %}
{% endblock %}

{% block bodyclass %}main_search{% endblock %}

{% block content %}
    <div class="container-fluid">
        <div class="row-fluid">
            <div class="span4 hidden-phone">
                <ul class="nav nav-collapse nav-tabs nav-stacked">
                {% for iso_pair, names in language_pairs.iteritems() %}
                    <li class="{%- if iso_pair[0] == _from and iso_pair[1] == _to %} active{% endif -%}">
                        <a href="/{{ iso_pair[0] }}/{{ iso_pair[1] }}/">
                        {% for lang, name in names.iteritems() %}
                            <span class="i18n" lang="{{ lang }}">{{ name[0] }} ↔ {{ name[1] }}</span>
                        {% endfor %}
                        </a></li>
                {% endfor %}
                </ul>
            </div>
            <div class="span8">
                <h4 id="dict_title">{%- for iso_pair, names in language_pairs.iteritems() %}
                    {% if iso_pair[0] == _from and iso_pair[1] == _to %}
                    {%- for lang, name in names.iteritems() %}
                        <span class="i18n" lang="{{ lang }}">{{ name[0] }} → {{ name[1] }}</span>
                    {% endfor -%}
                    {% endif %}
                    {% endfor -%}
                    <span style="font-size: 80%">(<a href="/{{ _to }}/{{ _from }}/">⇄ Swap</a>)</span></h4>

                <form id="neahttasaanit" class="form-inline"
                    method="post"
                    action="/{{ _from }}/{{ _to }}/">
                    <div class="input-append">
                        <input type="text" 
                               name="lookup" 
                               autocorrect="off"
                               autocapitalize="off"
                               data-language-from="{{ _from }}"
                               data-language-to="{{ _to }}"
                               {% if user_input -%}value="{{ user_input }}"{% endif %}
                               placeholder="ohcansátni"></input>
                               <button type="submit" class="btn" name="search">
                                   <span class="i18n" lang="sme">Oza</span>
                                   <span class="i18n" lang="nob">Søk</span>
                                   <span class="i18n" lang="fin">Hae</span>
                                   <span class="i18n" lang="eng">Search</span>
                               </button>
                    </div>
                </form>

                {# TODO: deep link needs to go to specific lexeme when it comes from the front page #}
                {% if word_searches %}
                    <div class="results">
                        <div class="row-fluid">
                            <span class="span7">
                            {% for lexeme in word_searches %}
                            {% if lexeme.lookups %}

                                {% for lookup in lexeme.lookups %}
                                <p><a href="/detail/{{ _from }}/{{ _to }}/{{ lookup.left }}.html?no_compounds=true&lemma_match=true&pos_filter={{ lookup.pos }}">
                                        {{ lookup.left }}
                                </a> ({{ lookup.pos }}) – </p>
                                <ol>
                                    {% for (tx, lang) in zip(lookup.right, lookup.lang) %}
                                    {% if lang %}
                                        {% if lang == _to %}
                                        <li>{% if tx.link %}<a href="/detail/{{ _to }}/{{ _from }}/{{ tx.tx }}.html?no_compounds=true&lemma_match=true">{% endif %}
                                                {{ tx.tx }}
                                            {% if tx.link %}</a>{% endif %} {% if tx.re %}({{ tx.re }}){% endif %}
                                            {% if tx.examples %}
                                                <div class="example_set">
                                                    <div class="button-padding">
                                                        <button class="btn btn-small visible-phone">Examples</button>
                                                    </div>
                                                    <blockquote class="examples hidden-phone">
                                                    <dl>
                                                        {%- for f_ex, t_ex in tx.examples %}
                                                        <dt>{{ f_ex }}</dt>
                                                        <dd>{{ t_ex }}</dd>
                                                        {%- endfor %}
                                                    </dl>
                                                    </blockquote>
                                                </div>
                                            {% endif %}
                                        </li>
                                        {% endif %}
                                    {% else %}
                                        <li>{% if tx.link %}<a href="/detail/{{ _to }}/{{ _from }}/{{ tx.tx }}.html?no_compounds=true&lemma_match=true">{% endif %}
                                                {{ tx.tx }}
                                        {% if tx.link %}</a>{% endif %} {% if tx.re %}({{ tx.re }}){% endif %}
                                        <blockquote class="examples">
                                        <dl>
                                            {%- for f_ex, t_ex in tx.examples %}
                                            <dt>{{ f_ex }}</dt>
                                            <dd>{{ t_ex }}</dd>
                                            {%- endfor %}
                                        </dl>
                                        </blockquote>
                                    </li>
                                    {% endif %}
                                    {% endfor %}
                                </ol>
                                {% endfor %}

                            {% else %}
                                {% if errors %}
                                    <div class="alert">
                                        <ul>
                                            {% for error in errors %}
                                            <li>{{ error }}</li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                {% else %}
                                    <p>
                                        <span class="i18n" lang="nob">Ukjent ord:</span>
                                        <span class="i18n" lang="sme">Amas sátni:</span>
                                        <span class="i18n" lang="fin">Tietämätön sana:</span>
                                        <span class="i18n" lang="nob">Unknown word:</span>
                                        {{ lexeme.input }}
                                    </p>
                                {% endif %}
                            {% endif %}

                            {% endfor %}
                            </span>

                            <div class="span5">
                                {%- if analyses %}
                                <div class="well">
                                    <p style="font-size: 95%;"><em>{{ user_input }}</em> is a possible form of ... </p>
                                    <dl class="possible_analyses">
                                        {% for grouper, forms in analyses|groupby(0) %}
                                        <dt>{{ grouper }}</dt>
                                        <dd><ul class="possible_forms">{% for form, pos, tag in forms %}<li>{{ ' '.join(tag)|tagfilter(_from) }}</li>{% endfor %}</ul></dd>
                                        {% endfor %}
                                    </dl>
                                </div>
                                {%- endif -%}
                            </div>

                        
                        </div>
                    </div>
                {% else %}
                    {% if not show_info %}
                    <div class="alert alert-error">
                        <p>
                            <span class="i18n" lang="nob">Ord {{ user_input }} ikke funnet.</span>
                            <span class="i18n" lang="fin">Sana {{ user_input }} ei löytynyt.</span>
                            <span class="i18n" lang="eng">Word {{ user_input }} not found.</span>
                            <span class="i18n" lang="sme">Sátni {{ user_input }} ii gávdnon.</span>
                        </p>
                    </div>
                    {% endif %}
                {% endif %}
                {% if show_info %}
                    <div class="alert alert-success">
                        <p>
                            <span class="i18n" lang="nob">Søk etter et ord, eller ordform for å få analyse og betydning.</span>
                            <span class="i18n" lang="fin">Kirjoita sana, eli sananmuoto saadakseen analyyseja ja tarkoitukseja.</span>
                            <span class="i18n" lang="eng">Search for a word, or a word form for a word analysis and definition.</span>
                            <span class="i18n" lang="sme">i18n: Søk etter et ord, eller ordform for å få analyse og betydning.</span>
                        </p>
                    </div>
                {% endif %}
            </div>
            
        </div>

<!--
    <div class="container">
        <br />
        <br />
        <br />
        <hr class="soften">
        <div class="marketing">
            <div class="row-fluid">
                <div class="span4">
                <h1>Open source, open data</h1>
                <p class="marketing-byline">Built on data you can use,
                    and with an open API for word information, and
                    linguistic tools.</p>
                </div>
                <div class="span4">
                <h1>Open source, open data</h1>
                <p class="marketing-byline">Built on data you can use,
                    and with an open API for word information, and
                    linguistic tools.</p>
                </div>
                <div class="span4">
                <h1>Open source, open data</h1>
                <p class="marketing-byline">Built on data you can use,
                    and with an open API for word information, and
                    linguistic tools.</p>
                </div>
            </div>
        </div>
-->
    </div>

    </div>
    <br />
{% endblock %}
